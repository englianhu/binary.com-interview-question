æ€»æ±‡ç»“è®º <- function(
    æ€»æ±‡ = NULL, æ–‡ä»¶å = 'æ—¥å†…æŒ‡æ•°å¹³æ»‘æ•°æ®', æ•°æ®é‡ = 1200, é¢‘ç‡ = 1, 
    æ—¶é—´ç´¢å¼•, é¢„æµ‹æ—¶é—´å•ä½ = 1, æ˜¯å¦å‚¨å­˜ç»“è®º = 'å‰', .åˆ—å° = 'å‹¾') {
  ## 
  ############################ æµ·çº³ç™¾å·ï¼Œæœ‰å®¹ä¹ƒå¤§ï¼› ############################
  ############################ ä¸‰å†›æœªåŠ¨ï¼Œç²®è‰å…ˆè¡Œã€‚ ############################
  ## 
  ## 2849108450@qq.com
  ## leiou123
  ## https://rstudio.cloud/project/1198888
  
  # èµ‹è¯— ----
  cat('\n=== å­™ä¸­å±±è’‹ä»‹çŸ³/æ¯›æ³½ä¸œï¼Œå¤§ç§¦èµ‹ï¼Œé»„åŸ”å†›æ ¡ï¼Œä¸­ç§‘çº¢æ——Asianuxå…µå·¥å‚ ===') 
  cat('\n=== å’±ä»¬äºšæ´²å…¬æ°‘ä¸­åæ°‘æ—ä¸å¯ä»¥æ­»ï¼Œå¤šå…ƒç§æ—çš„å®—æ—¨æ˜¯å„ç§æ—éƒ½éµå®ˆå„è‡ªå®—æ•™è¯­è¨€ä¹ ä¿—æ–‡åŒ–è§„çŸ© ===') 
  cat('\n======== æ˜¥ç§‹æˆ˜å›½ï¼Œè¯¸å­ç™¾å®¶ ========')
  cat('\n======== é¬¼è°·ä¼ å¥‡ï¼Œä¸­ç§‘çº¢æ—— ========')
  cat('\n======== é«˜é¢‘é‡åŒ–ï¼Œå¯¹å†²åŸºé‡‘ ========')
  cat('\n======== é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ ========')
  cat('\n======== å­¦æµ·æ— æ¶¯ï¼Œå”¯å‹¤æ˜¯å²¸ ========')
  cat('\n======== ä¸å¿˜åˆå¿ƒï¼Œæ–¹å¾—å§‹ç»ˆ ========')
  cat('\n========                 ========')
  cat('\n======== å·«è£”å®¦å®˜ï¼Œç¥¸å›½æ®ƒæ°‘ ========')
  cat('\n======== è‰è…äººå‘½ï¼Œæ°‘ä¸èŠç”Ÿ ========')
  cat('\n======== æ­¼ç­å·«è£”ï¼Œäººäººæœ‰è´£ ========')
  cat('\n======== ç»ˆæ­¢å± æ€ï¼Œæ‹¯æ•‘å…¨çƒ ========')
  cat('\n======== å·«è£”å°½å¼ƒï¼Œç“¦é‡œé›·é¸£ ========')
  cat('\n======== è«å¿˜åˆè¡·ï¼Œæ”¾å¾—å§‹ç»ˆ ========\n')
  
  ## è®¾ç½® ----
  options(digits = 22)
  require('tidyft', quietly = TRUE)
  require('forecast', quietly = TRUE)
  require('Ipaper', quietly = TRUE)
  conflicts_prefer(Ipaper::llply, .quiet = TRUE)
  conflicts_prefer(tidyft::mutate, .quiet = TRUE)
  conflicts_prefer(tidyft::rename, .quiet = TRUE)
  conflicts_prefer(tidyft::select, .quiet = TRUE)
  
  if (!exists('.èœ€é“') || is.null(.èœ€é“)) {
    .èœ€é“ <- getwd() |> 
      {\(.) str_split(., '/')}() |> 
      {\(.) c('/', .[[1]][2:5])}() |> 
      {\(.) c(., 'binary.com-interview-question-data/')}() |> 
      {\(.) paste(., collapse = '/')}() |> 
      {\(.) substring(., 2)}()
  }
  .èœ€é“ä»“åº“ <- paste0(.èœ€é“, 'è¯¸å­ç™¾å®¶å­¦åºœ/fx/USDJPY/ä»“åº“/')
  
  source('å‡½æ•°/æ±‡æ€»ä¸Šå¥.R')
  
  if (!is.data.table(æ€»æ±‡)) æ€»æ±‡ %<>% as.data.table
  if (!exists('æ€»æ±‡') || is.null(æ€»æ±‡)) {
    æ€»æ±‡ <- readRDS(paste0(.èœ€é“ä»“åº“, æ–‡ä»¶å, 'æ€»æ±‡.rds')) %>% 
      data.table
  }
  
  å¾ªç¯å‘¨æœŸ <- æ•°æ®é‡/é¢‘ç‡
  if (!is.null(æ€»æ±‡$æ—¥æœŸ)) è¿­ä»£åŸºå‡† <- æ€»æ±‡[æ—¥æœŸ %chin% æ—¶é—´ç´¢å¼•]$åºåˆ—
  if(!is.null(æ€»æ±‡$å¹´æœˆæ—¥æ—¶åˆ†)) è¿­ä»£åŸºå‡† <- æ€»æ±‡[å¹´æœˆæ—¥æ—¶åˆ† %chin% æ—¶é—´ç´¢å¼•]$åºåˆ—
  # è¿­ä»£åŸºå‡† <- æ€»æ±‡[æ—¥æœŸ %chin% æ—¶é—´ç´¢å¼• | å¹´æœˆæ—¥æ—¶åˆ† %chin% æ—¶é—´ç´¢å¼•]$åºåˆ—
  
  ## è¿­ä»£è¿ç®— ----
  æˆå“ <- llply(è¿­ä»£åŸºå‡†, function(è¿­æ•°ç”²) {
    
    #è¿­æ•°ç”² > 27
    è¿­æ•°åˆ—è¡¨ <- (è¿­æ•°ç”² - æ•°æ®é‡):(è¿­æ•°ç”² - 1)
    å›æµ‹æ€»æ±‡ <- æ€»æ±‡[åºåˆ— %chin% è¿­æ•°åˆ—è¡¨]
    å¹³æ»‘æ€»æ±‡ <- æ€»æ±‡[åºåˆ— == å›æµ‹æ€»æ±‡[.N]$åºåˆ— + é¢„æµ‹æ—¶é—´å•ä½]
    
    if (.åˆ—å° == 'å‹¾') {
      cat('\n=== å’±ä»¬äºšæ´²å…¬æ°‘ä¸­åæ°‘æ—ä¸å¯ä»¥æ­»ï¼Œå¤šå…ƒç§æ—çš„å®—æ—¨æ˜¯å„ç§æ—éƒ½éµå®ˆå„è‡ªå®—æ•™è¯­è¨€ä¹ ä¿—æ–‡åŒ–è§„çŸ©ï¼Œè€å­æè€³èŒ…å±±é“å£«æ¯›æ³½ä¸œé€®æ•ç¾å›½æ´‹ç•ª ===\n')
      cat('å›æµ‹æ€»æ±‡[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'å›æµ‹æ€»æ±‡æœ€ç»ˆåºåˆ—å·ï¼š', å›æµ‹æ€»æ±‡[.N]$åºåˆ—, ']\n')
      print(å›æµ‹æ€»æ±‡)
      
      cat('\n--- ç§¦å­å…¬/å§œå¤ªå…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼šä¸‡èˆ¬çš†ä¸‹å“ï¼Œå”¯æœ‰è¯»ä¹¦é«˜ã€‚---\n')
      cat('å¹³æ»‘æ€»æ±‡[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'å¹³æ»‘æ€»æ±‡åºåˆ—å·ï¼š', è¿­æ•°ç”², ']\n')
      print(å¹³æ»‘æ€»æ±‡)
    }
    
    ç»“è®º <- æ€»æ±‡[, {
      å¸‚åœºä»· = å¸‚åœºä»·
      é¢„æµ‹ä»· = é¢„æµ‹ä»·
      .SD[, .(.N, 
              MAE = MLmetrics::MAE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·), 
              MAPE = MLmetrics::MAPE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·), 
              RMSE = MLmetrics::RMSE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·), 
              SMAPE = Metrics::smape(actual = å¸‚åœºä»·, predicted = é¢„æµ‹ä»·), 
              MSE = MLmetrics::MSE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·)), 
          by = .(é¢‘ç‡)]}][order(é¢‘ç‡), ]
    setorder(ç»“è®º, é¢‘ç‡)
    setnames(ç»“è®º, old = c('N', 'MAE', 'MAPE', 'RMSE', 'SMAPE', 'MSE'), 
             new = c('é¢‘ç‡ï¼ˆåˆ†è®¡ï¼‰', 'å‡å¯¹è¯¯å·®ï¼ˆMAEï¼‰', 'å‡å¯¹ç™¾åˆ†æ¯”è¯¯å·®ï¼ˆMAPEï¼‰', 
                     'å‡æ–¹æ ¹è¯¯å·®ï¼ˆRMSEï¼‰', 'å¯¹ç§°å‡å¯¹ç™¾åˆ†æ¯”è¯¯å·®ï¼ˆSMAPEï¼‰', 
                     'å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰'))
    ç»“è®º[, 'å¹³å‡ç»å¯¹æ¯”ä¾‹è¯¯å·®ï¼ˆMASEï¼‰' := NA]
    ç»“è®º[, å¹´æœˆæ—¥æ—¶åˆ† := å¹³æ»‘æ€»æ±‡$å¹´æœˆæ—¥æ—¶åˆ†]#[] ## æ·»åŠ []åˆ—å°æ•°æ®
    
    æ˜¯å¦å‚¨å­˜ç»“è®º <- æ˜¯å¦å‚¨å­˜ç»“è®º
    if (!æ˜¯å¦å‚¨å­˜ç»“è®º %in% c('æ˜¯', 'å¦', 'å‹¾', 'å‰')) {
      stop("æ˜¯å¦å‚¨å­˜ç»“è®º = 'æ˜¯'ã€'å‹¾' æˆ– 'å¦'ã€'å‰'!")
      
    } else {
      if (æ˜¯å¦å‚¨å­˜ç»“è®º == 'æ˜¯' | æ˜¯å¦å‚¨å­˜ç»“è®º == 'å‹¾') {
        if (!dir.exists(paste0(.èœ€é“ä»“åº“, é¢‘ç‡)))
          dir.create(paste0(.èœ€é“ä»“åº“, é¢‘ç‡))
        
        æ–‡ä»¶èœ€é“ <- paste0(.èœ€é“ä»“åº“, é¢‘ç‡, '/', æ–‡ä»¶å, '_', ç»“è®º$å¹´æœˆæ—¥æ—¶åˆ†)
        saveRDS(ç»“è®º, paste0(æ–‡ä»¶èœ€é“, 'ç»“è®º.rds'))#, compress = FALSE)
        cat(paste0("\nå·²å‚¨å­˜'", æ–‡ä»¶èœ€é“, "'ç»“è®º.rds'ï¼\n"))
      }
    }
    
    ## åˆ—å°è¿›åº¦ ----
    cat('å¼€å§‹åˆ—å°è¿›åº¦\n')
    cat('\n--- ç§¦å­å…¬/å§œå¤ªå…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼šä¸‡èˆ¬çš†ä¸‹å“ï¼Œå”¯æœ‰è¯»ä¹¦é«˜ã€‚---\né¢„æµ‹æ•°æ®åºåˆ—å·ï¼š', 
        è¿­æ•°ç”², '\n', paste0(
          æ–‡ä»¶èœ€é“, '\nå·²å‚¨å­˜!\n\nè¿›åº¦ç”±0-1ï¼š', 
          length(è¿­ä»£åŸºå‡†[è¿­æ•°ç”² >= è¿­ä»£åŸºå‡†]) / length(è¿­ä»£åŸºå‡†), '\n\n'))
    cat('åˆ—å°è¿›åº¦å®Œæ¯•\n')
    gc()
  })#, .progress = 'text')
  ## å›å½’ ----
  return(æˆå“)
}
