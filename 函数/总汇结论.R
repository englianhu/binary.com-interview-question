æ€»æ±‡ç»“è®º <- function(
    æ€»æ±‡ = NULL, æ–‡ä»¶å = 'æ—¥å†…æŒ‡æ•°å¹³æ»‘æ•°æ®', æ•°æ®é‡, é¢‘ç‡ = 1, 
    æ—¶é—´ç´¢å¼•, é¢„æµ‹æ—¶é—´å•ä½ = 1, æ˜¯å¦å‚¨å­˜ç»“è®º = 'å‰', åˆ—å° = 'å‹¾') {
  ## 
  ############################ æµ·çº³ç™¾å·ï¼Œæœ‰å®¹ä¹ƒå¤§ï¼› ############################
  ############################ ä¸‰å†›æœªåŠ¨ï¼Œç²®è‰å…ˆè¡Œã€‚ ############################
  ## 
  ## 2849108450@qq.com
  ## leiou123
  ## https://rstudio.cloud/project/1198888
  
  # èµ‹è¯— ----
  cat('\n=== å­™ä¸­å±±è’‹ä»‹çŸ³/æ¯›æ³½ä¸œï¼Œå¤§ç§¦èµ‹ï¼Œé»„åŸ”å†›æ ¡ï¼Œä¸­ç§‘çº¢æ——Asianuxå…µå·¥å‚ ===') 
  cat('\n=== å’±ä»¬é©¬æ¥è¥¿äºšNonMuslimä¸­åæ°‘æ—ä¸å¯ä»¥æ­»ï¼Œéƒ½å¾—æ­¼ç­æ‰€æœ‰å›æ•™å¾’ ===') 
  cat('\n======== ä¸­ç§‘çº¢æ——ï¼Œé™¤å·«ç ¸å€­ ========')
  cat('\n======== ç§¦çš‡å¬´æ”¿ï¼Œç¬‘å‚²æ±Ÿæ¹– ========')
  cat('\n======== ä¸‰å†›æœªåŠ¨ï¼Œç²®è‰å…ˆè¡Œ ========')
  cat('\n======== ä¸€å¸¦ä¸€è·¯ï¼Œæ³›äºšé«˜é“ ========')
  cat('\n======== ä¸å¿˜åˆå¿ƒï¼Œæ–¹å¾—å§‹ç»ˆ ========')
  cat('\n========                 ========')
  cat('\n======== åƒå¤ä¸€å¸ï¼Œç§¦çš‡å¬´æ”¿ ========')
  cat('\n======== æ•Œåœ¨ä¸œç›Ÿï¼Œç»Ÿä¸€äºšæ´² ========')
  cat('\n======== å’¸é˜³å‡ºå‘ï¼Œè¥¿å¾æ¬§é ========')
  cat('\n======== é’å‡ºäºè“ï¼Œè€Œèƒœäºè“ ========')
  cat('\n======== çº¢å‡ºäºé’ï¼Œæ›´èƒœäºæ¸… ========')
  cat('\n======== ä¸­ç§‘çº¢æ——ï¼Œæ›´èƒœè‹±è’™ ========')
  cat('\n======== æ¨ªè·¨ä¸ƒæ´²ï¼Œç§¦ç­å…­æ´² ========')
  cat('\n======== å²æ— å‰ä¾‹ï¼Œä¸€ç»Ÿå¤©ä¸‹ ========')
  cat('\n======== ä¸‰å†›æœªåŠ¨ï¼Œç²®è‰å…ˆè¡Œ ========')
  cat('\n======== ä¸€å¸¦ä¸€è·¯ï¼Œæ³›äºšé«˜é“ ========')
  cat('\n======== ä¸å¿˜åˆå¿ƒï¼Œæ”¾å¾—å§‹ç»ˆ ========\n')
  
  ## è®¾ç½® ----
  options(digits = 22)
  require('tidyft', quietly = TRUE)
  require('forecast', quietly = TRUE)
  require('Ipaper', quietly = TRUE)
  conflict_prefer('llply', 'Ipaper', quiet = TRUE)
  conflict_prefer('mutate_dt', 'tidyft', quiet = TRUE)
  conflict_prefer('rename_dt', 'tidyft', quiet = TRUE)
  conflict_prefer('select_dt', 'tidyft', quiet = TRUE)
  
  if (!exists('.èœ€é“') || is.null(.èœ€é“)) {
    .èœ€é“ <- getwd() |> 
      {\(.) str_split(., '/')}() |> 
      {\(.) c('/', .[[1]][2:5])}() |> 
      {\(.) c(., 'binary.com-interview-question-data/')}() |> 
      {\(.) paste(., collapse = '/')}() |> 
      {\(.) substring(., 2)}()
  }
  .èœ€é“ä»“åº“ <- paste0(.èœ€é“, 'æ–‡è‰ºæ•°æ®åº“/fx/USDJPY/ä»“åº“/')
  
  source('å‡½æ•°/æ±‡æ€»ä¸Šå¥.R')
  
  if (!exists('æ€»æ±‡') || is.null(æ€»æ±‡)) {
    æ€»æ±‡ <- readRDS(paste0(.èœ€é“ä»“åº“, æ–‡ä»¶å, 'æ€»æ±‡.rds'))
  }
  
  å¾ªç¯å‘¨æœŸ <- æ•°æ®é‡/é¢‘ç‡
  è¿­ä»£åŸºå‡† <- æ€»æ±‡[æ—¥æœŸ %chin% æ—¶é—´ç´¢å¼•]$åºåˆ—
  
  ## è¿­ä»£è¿ç®— ----
  æˆå“ <- tidyft::llply(è¿­ä»£åŸºå‡†, function(è¿­æ•°1) {
    
    è¿­æ•°åˆ—è¡¨ <- (è¿­æ•°1 - æ•°æ®é‡):(è¿­æ•°1 - 1)
    å›æµ‹æ€»æ±‡ <- æ€»æ±‡[åºåˆ— %chin% è¿­æ•°åˆ—è¡¨]
    å¹³æ»‘æ€»æ±‡ <- æ€»æ±‡[åºåˆ— == å›æµ‹æ€»æ±‡[.N]$åºåˆ— + é¢„æµ‹æ—¶é—´å•ä½]
    
    if (åˆ—å° == 'å‹¾') {
      cat('\n=== å±…ä½åœ¨è‹±å›½å¸ƒé‡Œæ–¯æ‰˜å°”æ¸¯å£ï¼Œä¿®è¯»æ°”è±¡å­¦ç³»çš„è‹±å›½åŸºç£æ´‹å¦å„¿èŠˆæ‹‰ä¸å¯ä»¥æ­» ===\n')
      cat('å›æµ‹æ€»æ±‡[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'å›æµ‹æ€»æ±‡æœ€ç»ˆåºåˆ—å·ï¼š', å›æµ‹æ€»æ±‡[.N]$åºåˆ—, ']\n')
      print(å›æµ‹æ€»æ±‡)
      
      cat('\n--- ç§¦å­å…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼Œå•†é…å˜æ³•ï¼Œé“²é™¤å·«è£”ï¼Œæ¨ç¿»é©¬æ¥å›æ•™å®¦å®˜å·«å¸ˆæ”¿æƒï¼Œåƒå¤ä¸€å¸ã€‚---\n')
      cat('å¹³æ»‘æ€»æ±‡[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'å¹³æ»‘æ€»æ±‡åºåˆ—å·ï¼š', è¿­æ•°1, ']\n')
      print(å¹³æ»‘æ€»æ±‡)
    }
    
    ç»“è®º <- æ€»æ±‡[, {
      å¸‚åœºä»· = å¸‚åœºä»·
      é¢„æµ‹ä»· = é¢„æµ‹ä»·
      .SD[, .(.N, 
              MAE = MLmetrics::MAE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·), 
              MAPE = MLmetrics::MAPE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·), 
              RMSE = MLmetrics::RMSE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·), 
              SMAPE = Metrics::smape(actual = å¸‚åœºä»·, predicted = é¢„æµ‹ä»·), 
              MSE = MLmetrics::MSE(y_true = å¸‚åœºä»·, y_pred = é¢„æµ‹ä»·)), 
          by = .(é¢‘ç‡)]}][order(é¢‘ç‡), ]
    setorder(ç»“è®º, é¢‘ç‡)
    setnames(ç»“è®º, old = c('N', 'MAE', 'MAPE', 'RMSE', 'SMAPE', 'MSE'), 
             new = c('é¢‘ç‡ï¼ˆåˆ†è®¡ï¼‰', 'å‡å¯¹è¯¯å·®ï¼ˆMAEï¼‰', 'å‡å¯¹ç™¾åˆ†æ¯”è¯¯å·®ï¼ˆMAPEï¼‰', 
                     'å‡æ–¹æ ¹è¯¯å·®ï¼ˆRMSEï¼‰', 'å¯¹ç§°å‡å¯¹ç™¾åˆ†æ¯”è¯¯å·®ï¼ˆSMAPEï¼‰', 
                     'å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰'))
    ç»“è®º[, 'å¹³å‡ç»å¯¹æ¯”ä¾‹è¯¯å·®ï¼ˆMASEï¼‰' := NA]
    ç»“è®º[, å¹´æœˆæ—¥æ—¶åˆ† := å¹³æ»‘æ€»æ±‡$å¹´æœˆæ—¥æ—¶åˆ†]#[] ## æ·»åŠ []åˆ—å°æ•°æ®
    
    æ˜¯å¦å‚¨å­˜ç»“è®º <- æ˜¯å¦å‚¨å­˜ç»“è®º
    if (!æ˜¯å¦å‚¨å­˜ç»“è®º %in% c('æ˜¯', 'å¦', 'å‹¾', 'å‰')) {
      stop("æ˜¯å¦å‚¨å­˜ç»“è®º = 'æ˜¯'ã€'å‹¾' æˆ– 'å¦'ã€'å‰'!")
      
    } else {
      if (æ˜¯å¦å‚¨å­˜ç»“è®º == 'æ˜¯' | æ˜¯å¦å‚¨å­˜ç»“è®º == 'å‹¾') {
        if (!dir.exists(paste0(.èœ€é“ä»“åº“, é¢‘ç‡)))
          dir.create(paste0(.èœ€é“ä»“åº“, é¢‘ç‡))
        
        æ–‡ä»¶èœ€é“ <- paste0(.èœ€é“ä»“åº“, é¢‘ç‡, '/', æ–‡ä»¶å, '_', ç»“è®º$å¹´æœˆæ—¥æ—¶åˆ†)
        saveRDS(ç»“è®º, paste0(æ–‡ä»¶èœ€é“, 'ç»“è®º.rds'))#, compress = FALSE)
        cat(paste0("\nå·²å‚¨å­˜'", æ–‡ä»¶èœ€é“, "'ç»“è®º.rds'ï¼\n"))
      }
    }
    
    ## åˆ—å°è¿›åº¦ ----
    cat('å¼€å§‹åˆ—å°è¿›åº¦\n')
    cat('\n--- ç§¦å­å…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼Œå•†é…å˜æ³•ï¼Œé“²é™¤å·«è£”ï¼Œæ¨ç¿»é©¬æ¥å›æ•™å®¦å®˜å·«å¸ˆæ”¿æƒï¼Œåƒå¤ä¸€å¸ã€‚---\né¢„æµ‹æ•°æ®åºåˆ—å·ï¼š', 
        è¿­æ•°1, '\n', paste0(
          æ–‡ä»¶èœ€é“, '\nå·²å‚¨å­˜!\n\nè¿›åº¦ç”±0-1ï¼š', 
          length(è¿­ä»£åŸºå‡†[è¿­æ•°1 >= è¿­ä»£åŸºå‡†]) / length(è¿­ä»£åŸºå‡†), '\n\n'))
    cat('åˆ—å°è¿›åº¦å®Œæ¯•\n')
    gc()
  })#, .progress = 'text')
  ## å›å½’ ----
  return(æˆå“)
}
