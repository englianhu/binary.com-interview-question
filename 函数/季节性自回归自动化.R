å­£èŠ‚æ€§è‡ªå›å½’è‡ªåŠ¨åŒ– <- function(æ—¶é—´ç´¢å¼•, æ ·æœ¬, .å·®åˆ†é˜¶æ•°, .å­£èŠ‚æ€§å·®åˆ†é˜¶æ•°, 
                      .èœ€é“ = NULL, é¢„æµ‹æ—¶é—´å•ä½ = 1, 
                      æ–‡ä»¶å = 'å­£èŠ‚æ€§è‡ªå›å½’è‡ªåŠ¨åŒ–', æ•°æ®é‡, é¢‘ç‡ = 1, 
                      å‘¨æœŸå»ºæ¨¡ = c('ts', 'xts', 'zoo', 'mts'), åˆ—å° = 'å‹¾') {
  
  # èµ‹è¯— ----
  cat('\n=== å­™ä¸­å±±è’‹ä»‹çŸ³/æ¯›æ³½ä¸œï¼Œå¤§ç§¦èµ‹ï¼Œé»„åŸ”å†›æ ¡ï¼Œä¸­ç§‘çº¢æ——Asianuxå…µå·¥å‚ ===') 
  cat('\n=== å’±ä»¬é©¬æ¥è¥¿äºšä¸–è¢­åˆ¶é“å®¶ä¸­åæ°‘æ—ä¸å¯ä»¥æ­»ï¼Œéƒ½å¾—æ­¼ç­æ‰€æœ‰å›æ•™å¾’å’Œå³‡å³‡å¨˜æƒ¹ ===') 
  cat('\n======== ä¸­ç§‘çº¢æ——ï¼Œé™¤å·«ç ¸å€­ ========')
  cat('\n======== ç§¦çš‡å¬´æ”¿ï¼Œç¬‘å‚²æ±Ÿæ¹– ========')
  cat('\n======== ä¸‰å†›æœªåŠ¨ï¼Œç²®è‰å…ˆè¡Œ ========')
  cat('\n======== ä¸€å¸¦ä¸€è·¯ï¼Œæ³›äºšé«˜é“ ========')
  cat('\n======== ä¸å¿˜åˆå¿ƒï¼Œæ–¹å¾—å§‹ç»ˆ ========')
  cat('\n========                 ========')
  cat('\n======== åƒå¤ä¸€å¸ï¼Œç§¦çš‡å¬´æ”¿ ========')
  cat('\n======== æ•Œåœ¨ä¸œç›Ÿï¼Œç»Ÿä¸€äºšæ´² ========')
  cat('\n======== å’¸é˜³å‡ºå‘ï¼Œè¥¿å¾æ¬§é ========')
  cat('\n======== é’å‡ºäºè“ï¼Œè€Œèƒœäºè“ ========')
  cat('\n======== çº¢å‡ºäºé’ï¼Œæ›´èƒœäºæ¸… ========')
  cat('\n======== ä¸­ç§‘çº¢æ——ï¼Œæ›´èƒœè‹±è’™ ========')
  cat('\n======== æ¨ªè·¨ä¸ƒæ´²ï¼Œç§¦ç­å…­æ´² ========')
  cat('\n======== å²æ— å‰ä¾‹ï¼Œä¸€ç»Ÿå¤©ä¸‹ ========')
  cat('\n======== ä¸‰å†›æœªåŠ¨ï¼Œç²®è‰å…ˆè¡Œ ========')
  cat('\n======== ä¸€å¸¦ä¸€è·¯ï¼Œæ³›äºšé«˜é“ ========')
  cat('\n======== ä¸å¿˜åˆå¿ƒï¼Œæ”¾å¾—å§‹ç»ˆ ========\n')
  
  ## è®¾ç½® ----
  options(digits = 22)
  require('tidyft', quietly = TRUE)
  require('forecast', quietly = TRUE)
  require('Ipaper', quietly = TRUE)
  conflicted::conflict_prefer('llply', 'Ipaper', quiet = TRUE)
  conflicted::conflict_prefer('mutate_dt', 'tidyft', quiet = TRUE)
  conflicted::conflict_prefer('rename_dt', 'tidyft', quiet = TRUE)
  conflicted::conflict_prefer('select_dt', 'tidyft', quiet = TRUE)
  
  if (!'data.table' %in% class(æ ·æœ¬)) æ ·æœ¬ %<>% as.data.table
  
  if (!exists('.èœ€é“') || is.null(.èœ€é“)) {
    .èœ€é“ <- getwd() |> 
      {\(.) str_split(., '/')}() |> 
      {\(.) c('/', .[[1]][2:5])}() |> 
      {\(.) c(., 'binary.com-interview-question-data/')}() |> 
      {\(.) paste(., collapse = '/')}() |> 
      {\(.) substring(., 2)}()
  }
  .èœ€é“ä»“åº“ <- paste0(.èœ€é“, 'è¯¸å­ç™¾å®¶å­¦åºœ/fx/USDJPY/ä»“åº“/')
  
  #if (!is.numeric(.å·®åˆ†é˜¶æ•°) && length(.å·®åˆ†é˜¶æ•°) != 1) 
  #  stop(".å·®åˆ†é˜¶æ•° = 0 æˆ– 1 æˆ– 2")
  #if (!is.numeric(.å­£èŠ‚æ€§å·®åˆ†é˜¶æ•°) && length(.å­£èŠ‚æ€§å·®åˆ†é˜¶æ•°) != 1) 
  #  stop(".å­£èŠ‚æ€§å·®åˆ†é˜¶æ•° = 0 æˆ– 1")
  #if (!é™æ€ä¸å¦ %in% c('å‹¾', 'å‰')) stop("é™æ€ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!å­£èŠ‚æ€§ä¸å¦ %in% c('å‹¾', 'å‰')) stop("å­£èŠ‚æ€§ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!ä¿¡æ¯é‡å‡†åˆ™ %in% c('aicc', 'aic', 'bic')) 
  #  stop("ä¿¡æ¯é‡å‡†åˆ™ = 'aicc' æˆ– 'aic' æˆ– 'bic'")
  #if (!æµ‹è¯• %in% c('kpss', 'adf', 'pp')) 
  #  stop("æµ‹è¯• = 'kpss' æˆ– 'adf' æˆ– 'pp'")
  #if (!å­£èŠ‚æ€§æµ‹è¯• %in% c('seas', 'ocsb', 'hegy', 'ch'))
  #  stop("å­£èŠ‚æ€§æµ‹è¯• = 'seas' æˆ– 'ocsb' æˆ– 'hegy' æˆ– 'ch'")
  #if (!é€æ­¥ç²¾åŒ–ä¸å¦ %in% c('å‹¾', 'å‰')) stop("é€æ­¥ç²¾åŒ–ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!è®°è½½è‡ªå›å½’ä¸å¦ %in% c('å‹¾', 'å‰')) stop("è®°è½½è‡ªå›å½’ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!å…è®¸æˆªè·ä¸å¦ %in% c('å‹¾', 'å‰')) stop("å…è®¸æˆªè·ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!å…è®¸å‡å€¼ä¸å¦ %in% c('å‹¾', 'å‰')) stop("åŒ…å«å‡å€¼ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!åå·®è°ƒæ•´ä¸å¦ %in% c('å‹¾', 'å‰')) stop("åå·®è°ƒæ•´ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!å¤šç®¡é½ä¸‹ä¸å¦ %in% c('å‹¾', 'å‰')) stop("å¤šç®¡é½ä¸‹ä¸å¦ = 'å‹¾' æˆ– 'å‰'")
  #if (!åˆ—å° %in% c('å‹¾', 'å‰')) stop("åˆ—å° = 'å‹¾' æˆ– 'å‰'")
  
  ## æ’ç‰ˆ ----
  ## å‡è®¾æ•°æ®é‡ = 1200åˆ†é’Ÿ
  ## é¢‘ç‡ = 1200
  ## 20å°æ—¶ä¸€å‘¨æœŸï¼ˆ1200åˆ†é’Ÿå¾ªç¯1æ¬¡ï¼‰
  ## 10å°æ—¶ä¸€å‘¨æœŸï¼ˆ600åˆ†é’Ÿå¾ªç¯2æ¬¡ï¼‰
  å¾ªç¯å‘¨æœŸ <- æ•°æ®é‡/é¢‘ç‡
  è¿­ä»£åŸºå‡† <- æ ·æœ¬[æ—¥æœŸ %chin% æ—¶é—´ç´¢å¼•]$åºåˆ—
  
  ## è¿­ä»£è¿ç®— ----
  æˆå“ <- llply(è¿­ä»£åŸºå‡†, function(è¿­æ•°1) {
    
    è¿­æ•°åˆ—è¡¨ <- (è¿­æ•°1 - æ•°æ®é‡):(è¿­æ•°1 - 1)
    åŸ¹è®­æ ·æœ¬ <- æ ·æœ¬[åºåˆ— %chin% è¿­æ•°åˆ—è¡¨]
    é¢„æµ‹æ ·æœ¬ <- æ ·æœ¬[åºåˆ— == åŸ¹è®­æ ·æœ¬[.N]$åºåˆ— + é¢„æµ‹æ—¶é—´å•ä½]
    
    if (åˆ—å° == 'å‹¾') {
      cat('\n=== å’±ä»¬äºšæ´²ä¸–è¢­åˆ¶é“æ•™å¾’èµ¢å®¶é»„æ°æ±Ÿå¤å ‚è”å¯Œå’Œå®¶çœ·äº²å±éƒ½ä¸å¯ä»¥æ­»ï¼Œå­¦æœ¯ä¼˜å…ˆï¼Œæ‹¯æ•‘äºšæ´²äºº ===\n')
      cat('åŸ¹è®­æ ·æœ¬[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'åŸ¹è®­æ ·æœ¬æœ€ç»ˆåºåˆ—å·ï¼š', åŸ¹è®­æ ·æœ¬[.N]$åºåˆ—, ']\n')
      print(åŸ¹è®­æ ·æœ¬)
      
      cat('\n--- ç§¦å­å…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼Œå•†é…å˜æ³•ï¼Œé“²é™¤å·«è£”ï¼Œæ¨ç¿»é©¬æ¥å›æ•™å®¦å®˜å·«å¸ˆæ”¿æƒï¼Œåƒå¤ä¸€å¸ã€‚---\n')
      cat('é¢„æµ‹æ ·æœ¬[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'é¢„æµ‹æ ·æœ¬åºåˆ—å·ï¼š', è¿­æ•°1, ']\n')
      print(é¢„æµ‹æ ·æœ¬)
    }
    
    ## å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹ ----
    # å­£å›å½’ <- åŸ¹è®­æ ·æœ¬[, .(å¹´æœˆæ—¥æ—¶åˆ†, é—­å¸‚ä»·)] %>% 
    #   as.matrix %>% 
    #   tk_ts(frequency = é¢‘ç‡)
    ## 
    ## åœ¨tsã€xtsã€matrixã€zooæ ¼å¼ä¸Šä½¿ç”¨auto.arima #8
    ## https://github.com/englianhu/binary.com-interview-question/issues/8#issue-1515678585
    if (å‘¨æœŸå»ºæ¨¡ == 'ts') {
      cat('å¼€å§‹å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹\n')
      å­£å›å½’ <- åŸ¹è®­æ ·æœ¬$é—­å¸‚ä»· |> 
        {\(.) matrix(., dimnames = list(åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†, 'é—­å¸‚ä»·'))}() |> 
        {\(.) tk_ts(., frequency = é¢‘ç‡)}()
      rownames(å­£å›å½’) <- åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†
      cat('å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹å®Œæ¯•\n')
    }
    
    if (å‘¨æœŸå»ºæ¨¡ == 'xts') {
      cat('å¼€å§‹å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹\n')
      å­£å›å½’ <- åŸ¹è®­æ ·æœ¬$é—­å¸‚ä»· |> 
        {\(.) matrix(., dimnames = list(åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†, 'é—­å¸‚ä»·'))}() |> 
        {\(.) xts(., frequency = é¢‘ç‡)}()
      rownames(å­£å›å½’) <- åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†
      cat('å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹å®Œæ¯•\n')
    }
    
    if (å‘¨æœŸå»ºæ¨¡ == 'zoo') {
      cat('å¼€å§‹å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹\n')
      å­£å›å½’ <- åŸ¹è®­æ ·æœ¬$é—­å¸‚ä»· |> 
        {\(.) matrix(., dimnames = list(åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†, 'é—­å¸‚ä»·'))}() |> 
        {\(.) zoo(., frequency = é¢‘ç‡)}()
      rownames(å­£å›å½’) <- åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†
      cat('å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹å®Œæ¯•\n')
    }
    
    if (å‘¨æœŸå»ºæ¨¡ == 'msts') {
      cat('å¼€å§‹å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹\n')
      å­£å›å½’ <- åŸ¹è®­æ ·æœ¬$é—­å¸‚ä»· |> 
        {\(.) matrix(., dimnames = list(åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†, 'é—­å¸‚ä»·'))}() |> 
        # msts(data, seasonal.periods, ts.frequency = floor(max(seasonal.periods)), ...)
        # x <- msts(taylor, seasonal.periods=c(2*24,2*24*7,2*24*365), start=2000+22/52)
        # y <- msts(USAccDeaths, seasonal.periods=12, start=1949)
        {\(.) msts(., ts.frequency = é¢‘ç‡)}()
      rownames(å­£å›å½’) <- åŸ¹è®­æ ·æœ¬$å¹´æœˆæ—¥æ—¶åˆ†
      cat('å»ºç«‹å­£èŠ‚æ€§æ¨¡å‹å®Œæ¯•\n')
    }
    
    ## è¿ç®—å­£å›å½’ ----
    cat('å¼€å§‹è¿ç®—å­£å›å½’\n')
    åŠæˆå“ <- tryCatch({
      auto.arima(å­£å›å½’, d = .å·®åˆ†é˜¶æ•°, D = .å­£èŠ‚æ€§å·®åˆ†é˜¶æ•°)
      }, é”™è¯¯ä¿¡æ¯ = function(é”™è¯¯ä¿¡æ¯å‚æ•°) NULL)
    cat('è¿ç®—å®Œæ¯•å­£å›å½’\n')
    
    ## è¿ç®—é¢„æµ‹æ±‡ä»· ----
    cat('å¼€å§‹è¿ç®—é¢„æµ‹æ±‡ä»·\n')
    é¢„æµ‹æ±‡ä»· <- åŠæˆå“ |> 
      forecast::forecast(h = é¢„æµ‹æ—¶é—´å•ä½)
    cat('è¿ç®—å®Œæ¯•é¢„æµ‹æ±‡ä»·\n')
    
    ## æ•´é¡¿é¢„æµ‹æ±‡ä»· ----
    cat('å¼€å§‹æ•´é¡¿é¢„æµ‹æ±‡ä»·\n')
    åŠæˆå“ <- é¢„æµ‹æ ·æœ¬ |> 
      {\(.) mutate_dt(., å¸‚åœºä»· = é—­å¸‚ä»·, 
                      é¢„æµ‹ä»· = as_tibble(é¢„æµ‹æ±‡ä»·)$`Point Forecast`)}() |> 
      {\(.) select_dt(., å¹´æœˆæ—¥æ—¶åˆ†, å¸‚åœºä»·, é¢„æµ‹ä»·)}()
    cat('æ•´é¡¿å®Œæ¯•é¢„æµ‹æ±‡ä»·\n')
    
    ## å‘½åç»Ÿè®¡æ¨¡å‹ ----
    cat('å¼€å§‹å‘½åç»Ÿè®¡æ¨¡å‹\n')
    æ¨¡å‹åç§° <- paste0(
      'è‡ªåŠ¨å­£å›å½’_å·®åˆ†é˜¶æ•°_', .å·®åˆ†é˜¶æ•°, '_å­£èŠ‚æ€§å·®åˆ†é˜¶æ•°_', .å­£èŠ‚æ€§å·®åˆ†é˜¶æ•°, 
      '_æ•°æ®é‡', æ•°æ®é‡, '_é¢‘ç‡', é¢‘ç‡, '_é¢„æµ‹æ—¶é—´å•ä½', é¢„æµ‹æ—¶é—´å•ä½, 
      '_', åŠæˆå“$å¹´æœˆæ—¥æ—¶åˆ†, 'CST.rds')
    cat('å‘½åç»Ÿè®¡æ¨¡å‹å®Œæ¯•\n')
    
    cat('å¼€å§‹åˆ—å°åŠæˆå“\n')
    if (åˆ—å° == 'å‹¾') {
      cat('\n--- ç§¦å­å…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼Œå•†é…å˜æ³•ï¼Œé“²é™¤å·«è£”ï¼Œæ¨ç¿»é©¬æ¥å›æ•™å®¦å®˜å·«å¸ˆæ”¿æƒï¼Œåƒå¤ä¸€å¸ã€‚---\n')
      cat('é¢„æµ‹æ ·æœ¬[', 'æ•°æ®é‡ï¼š', æ•°æ®é‡, 'é¢‘ç‡ï¼š', é¢‘ç‡, '-', 
          'é¢„æµ‹æ•°æ®åºåˆ—å·ï¼š', è¿­æ•°1, ']\n')
      print(åŠæˆå“)
    }
    cat('åˆ—å°åŠæˆå“å®Œæ¯•\n')
    
    ## å‚¨å­˜åŠæˆå“ ----
    cat('å¼€å§‹å‚¨å­˜åŠæˆå“\n')
    if (!dir.exists(paste0(.èœ€é“ä»“åº“, é¢‘ç‡)))
      dir.create(paste0(.èœ€é“ä»“åº“, é¢‘ç‡))
    æ–‡ä»¶èœ€é“ <- paste0(.èœ€é“ä»“åº“, é¢‘ç‡, '/', æ¨¡å‹åç§°)
    saveRDS(åŠæˆå“, æ–‡ä»¶èœ€é“)
    cat('å‚¨å­˜åŠæˆå“å®Œæ¯•\n')
    
    ## åˆ—å°è¿›åº¦ ----
    cat('å¼€å§‹åˆ—å°è¿›åº¦\n')
    cat('\n--- ç§¦å­å…¬ğŸŒŸé™ˆç¥¯ç¦„ï¼Œå•†é…å˜æ³•ï¼Œé“²é™¤å·«è£”ï¼Œæ¨ç¿»é©¬æ¥å›æ•™å®¦å®˜å·«å¸ˆæ”¿æƒï¼Œåƒå¤ä¸€å¸ã€‚---\né¢„æµ‹æ•°æ®åºåˆ—å·ï¼š', 
        è¿­æ•°1, '\n', paste0(
          æ–‡ä»¶èœ€é“, '\nå·²å‚¨å­˜!\n\nè¿›åº¦ç”±0-1ï¼š', 
          length(è¿­ä»£åŸºå‡†[è¿­æ•°1 >= è¿­ä»£åŸºå‡†]) / length(è¿­ä»£åŸºå‡†), '\n\n'))
    rm(åŠæˆå“)
    cat('åˆ—å°è¿›åº¦å®Œæ¯•\n')
    gc()
  })#, .progress = 'text')
  ## å›å½’ ----
  return(æˆå“)
}
