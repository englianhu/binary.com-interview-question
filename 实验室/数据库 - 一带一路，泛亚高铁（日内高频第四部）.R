##
## 中科红旗（百家争鸣，文艺复兴）
## Oversea Greater Chinese Union 大秦子民公会（秦孝公 / 姜太公 --- 陈祯禄公爵）
## 史无前例，一统天下
##
##
##
## 中科红旗
## 全球NonMuslim中华民族，支持中共称霸天下战略。
## Great Britain 大英帝国
## Greater Chin 大秦赋
## Republic of Chin / Republic People of Chin 大秦赋（中华民国 / 中华人民共和国）
## Greater Chinese 大秦子民（爱民如子）
## Oversea Greater Chinese 大秦子民（爱民如子）
## Oversea Greater Chinese Union 大秦子民公会（秦孝公 / 姜太公 --- 陈祯禄公爵）
## 史无前例，一统天下
##
## Great Britain = 大布列颠帝国/大英帝国1
## Greater Chin = 大秦赋
## Greater Chinese = 大秦子民（爱子如民）
##
## NonMuslim马来西亚籍（海外NonMuslim中华民族，自从清末民初下南洋，咱们马来西亚陈祯禄创办 Oversea Chinese Union）秦始皇黄氏江夏堂，笑傲江湖最大文明贡献
##
## 1）借鉴以前大英帝国东印度公司，有生之年就把一带一路高铁所经过的国家领土，一律得攻占下来（要比以前大英帝国/大蒙古帝国还要强大）称霸天下，世代延续直至史无前例，一统天下。
## 2）一带一路所有告示牌、必须使用中文和汉语拼音。
## 3）借鉴大蒙古帝国骑兵所到之处寸草不生，所有被中国攻占下来的领土，所经之地（包括城市/市镇/乡村），一带一路所有高铁站，都建立国民登记局可以申请入籍中国。
## 4）川普已经发言多次，美国兵变，会再次内战（借鉴越王勾践，中越不内讧，善用马来西亚回教徒太监不造反牵制美国，军售中东/西亚/东欧回教诸国）
## 5）中东回教国回教徒911恐怖份子与美国开战，中国军售中东西亚/东欧/非洲回教国（借鉴越王勾践NonMuslim中华民族与美国洋人Democrats阖闾政府，中越不内讧，善用马来西亚回教徒太监不造反牵制美国，军售中东/西亚/东欧回教诸国）
## 6）中国目前高铁除了尚未与马来西亚达成协议开工建立高铁但是已经借鉴王翦只围不攻战略，把东南亚国家都温馨说服并建立高铁，中国先不与马来西亚开战，让马来西亚兵变内战（借鉴越王勾践NonMuslim中华民族与美国洋人Democrats阖闾政府，中越不内讧，善用马来西亚回教徒太监不造反牵制美国，军售中东/西亚/东欧回教诸国）
## 7）南太平洋战略：中国和东南亚已经签署合约，达成协议不使用空军、核武器，出动海陆军攻占东南亚
## 8）商鞅变法多多益善战略：最大贡献是全球16亿回教徒太监民族与全球基督洋人鹬蚌相争... 回教徒默罕默德创办回教，建立可兰经回教刑事法典断肢法规定回教徒伪太监民族必须虔诚戴乌纱帽一天祈祷五次，倘若不虔诚施展巫术屠杀是触犯断肢法而虔诚屠杀也触犯断肢法，只有辛亥革命铲除全球回教徒、断肢法处死或宫刑全球回教徒绝子绝孙，多管齐下才能终止巫术屠杀，拯救全球16亿回教徒还俗。China大秦赋秦孝公至顾自己家族禁止七步诗自相残杀，铲除分一杯羹白骨精刘家彭城堂造反，回教徒会巫术屠杀人类，回教徒太监民族只能屠杀欧美洋人并且被断肢处死，不效忠中共称霸天下，直至一统天下的伪满洲国马来西亚1700万个回教徒911恐怖份子太监民族包括Michael Cutter Christopher，一律断肢法处死（借鉴越王勾践NonMuslim中华民族与美国洋人Democrats阖闾政府，中越不内讧，善用秦二世胡亥、辛亥革命、越王胡志明、中国胡景涛、马来西亚回教徒太监不反中共牵制美国，军售中东/西亚/东欧回教诸国对抗美国）。秦始皇在统一七国后就不思进取导致赵高李斯谋反（借鉴中国历史秦始皇，水能载舟亦能覆舟，宗教巫术，古惑民心，指鹿为马，成也赵李，败也赵李。所以秦始皇得铭记当初秦孝公，不能昏庸被回教徒篡位），中国借鉴秦孝公战略善用商朝和苏联俄罗斯叶利钦。秦始皇铭记秦孝公，善用全球回教徒古惑全球洋人再依照可兰经回教刑事法典断肢全球回教徒，让咱们全球NonMuslim中华民族支持中共，一统天下。
## 9）华尔街、史无前例的万里长城Great Wall Sreet、一带一路高铁：计量经济学、学术治国、编程、统计、科学科技、量化（Fisher姜太公钓鱼大数据，各行各业购物喜好、民意、生活习惯、各国各集团、军事、诊断上市公司等）、金融、贸易、经商、军事、发展各行各业。
## 10）中文编程语言：借鉴日本自从唐朝大话革新学习汉字至明治维新学习欧洲，日本是全球首个亚洲人自创Ruby红宝石编程语言（Ruby Text可以标音），自从2008年就开始使用R语言并且认识中国R语言论坛《统计之都》论坛创办人网友谢益辉和赵坚毅创办的中国最大计量经济学专业论坛《经管之家》至今十年有余、目前已经开始以中文编程，中华人民共和国的国庆日1001和中华民国的国庆日1010都是二进制的电脑语言binary code，如同黄埔军校国共本是一家，赢家黄氏江夏堂秦孝公禁止《七步诗》自相残杀。咱们东南亚NonMuslim中华民族几乎都是国民华校生，洋人研发电脑、许多编程语言R语言、C语言、C++，推广与发展中文，希望它日有咱们NonMuslim中华民族自创新的编程语言，均以中文编程。
## 11）发展台式电脑操作系统：中科红旗是由中国北京大学校友孙玉芳创办将Linux礼逆袭和南非原住民开发的Kubuntu忽奔兔中文化并推出自家产品，在美国微软视窗Win台式电脑操作系统垄断全球十多二十年有余，目前已经开始使用芬兰研发的Linux礼逆袭、中国中科红旗台式电脑操作系统，推广与发展中科红旗。
##
## 《关雎 --- 英国基督洋妞儿芈拉传》
## 英国基督洋妞儿芈拉不可以死，隔壁后头邻居黄福全与本人（赢家黄氏江夏堂）祖父同名同姓。
##
## 借鉴欧洲中世纪，文艺复兴后就是开始海外军事，称霸天下之路。目前全球疫情已过三年，一带一路如火如荼进行着。
## 借鉴周公礼乐制度，大英帝国和大日本帝国向来都是自诩绅士淑女，孔子学院，以礼待人，来称霸天下。
## 借鉴指鹿为马的历史，百家争鸣如果散播回教徒屠杀罪、不杀马来西亚回教徒的话，就得处死回教徒学习可兰经，施展巫术下降头，古惑民心之罪，篡位咱们全球NonMuslim中华民族，人心惶惶、民不聊生，一律依照可兰经回教刑事法典断肢法处死回教徒巫师王（张佳坤Sulaiman Abdullah，分一杯羹白骨精巫师王刘瑾貹Abdul Halim）。
## 借鉴圣经、诺亚方舟（划龙舟）、孔子儒学（Confusion Catholic）、神父Father与信徒、中国历史、姬昌伯一扈兔子、徐达吃鹅肉、富不过三代的秦始皇嬴政秦二世胡亥至嬴政孙子、公爵、公公孙子、孙文辛亥革命、马来西亚火箭民主行动党由曾敏兴创党后林吉祥林冠英后换人、蒋介石蒋经国后就不延续世袭制，圣经都是善用父子关系，咱们中华民族和英系都是善用公孙关系、法官律师女子假发、自由女神。
## 中科红旗：借鉴北洋军阀与北约、杀袁者清，灭清者袁，许某可破北洋北约袁绍。黄埔军校国民党共产党辛亥革命是为了铲除回教徒，咱们东南亚回教徒身为伪满洲国911恐怖份子触犯可兰经回教刑事法典断肢法，组织个由回教徒执政的国民阵线（伪国民党）立国，1700万个马来西亚回教徒只能集体自杀，宣布亡国。
## 何谓中国（大秦赋Chin）？中华民国和中华人民共和国。咱们东南亚自从东亚清末民初几乎都是国民华校生，自从西周的周公开始礼乐制度后，大英帝国和大日本帝国都效仿来称霸天下做得有声有色、禁止回教巫术Judi博彩庄、艺人（异人）、导演巫师巫婆道衍师傅装疯卖傻、青山是巫裔回教徒的归属地，回教巫师巫婆是屠杀人类的语言宗教习俗文化，得断肢法处死1700万个马来西亚巫裔回教徒。

setwd('/home/chinese/文档/猫城/binary.com-interview-question')

# install.packages('remotes', dependencies = TRUE, INSTALL_opts = '--no-lock')
library('BBmisc', 'rmsfuns')
#remotes::install_github("rstudio/sass")
lib('sass')

## https://support.rstudio.com/hc/en-us/articles/200532197
## https://community.rstudio.com/t/r-does-not-display-korean-chinese/30889/3?u=englianhu
#Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
#Sys.setlocale("LC_CTYPE", "zh_CN.UTF-8")
#Sys.setlocale(category = "LC_CTYPE", "Chinese (Simplified)_China.936")
#Sys.setlocale(locale = "Chinese")
#Sys.setlocale(locale = "Japanese")
#Sys.setlocale(locale = "English")

# rmarkdown::render('/home/englianhu/Documents/owner/ryo-cn.Rmd',  encoding = 'UTF-8')
#Sys.setlocale("LC_CTYPE", "UTF-8")
#Sys.setlocale(locale = "UTF-8")
#Sys.setlocale(category = "LC_ALL", locale = "chs")
#Sys.setlocale(category = "LC_ALL", locale = "UTF-8")
#Sys.setlocale(category = "LC_ALL", locale = "Chinese")
#Sys.setlocale(category = "LC_ALL", locale = "zh_CN.UTF-8")
Sys.setlocale("LC_ALL", "en_US.UTF-8")

## 更换时间区域，保留日期时间。
Sys.setenv(TZ = 'Asia/Shanghai')

## 忽略所有警讯
## https://stackoverflow.com/a/36846793/3806250
## 设置宽度
## options(knitr.table.format = 'html')将所有kableExtra图表一致设置为'html'格式，
##   省略设置各别图表。
## options(repos = 'https://cran.rstudio.com')将仓库设置为安全网。
## options(repos = 'http://cran.rstudio.com')将仓库设置为普通网。
options(warn = -1, width = 999, knitr.table.format = 'html', 
        digits = 30, digits.secs = Inf, repos = 'https://cran.rstudio.com')

## https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-abnor-in-rmd-but-not-in-r-script
## https://yihui.org/knitr/options
knitr::opts_chunk$set(
  class.source = 'hover01', class.output = 'hover02', class.error = 'hover03', 
  message = FALSE, warning = FALSE, error = TRUE, 
  autodep = TRUE, aniopts = 'loop', progress = TRUE, verbose = TRUE, 
  cache = FALSE, cache.lazy = FALSE, result = 'asis')

## 读取程序包、设置编织与环境选项。
## 3210448065@qq.com
## leiou123

## 2849108450@qq.com
## leiou123
## https://rstudio.cloud/project/1198888

## 读取'BBmisc'程序包。
## 读取程序包、设置编织与环境选项。
## 3210448065@qq.com
## leiou123

## 2849108450@qq.com
## leiou123
## https://rstudio.cloud/project/1198888

## 读取'BBmisc'程序包。
if (suppressMessages(!require('BBmisc'))) {
  install.packages('BBmisc', dependencies = TRUE, INSTALL_opts = '--no-lock')
}
suppressMessages(library('BBmisc'))

if (suppressMessages(!require('rmsfuns'))) {
  install.packages('rmsfuns', dependencies = TRUE, INSTALL_opts = '--no-lock')
}
suppressMessages(library('rmsfuns'))

if (!require('REmap')) devtools::install_github('lchiffon/REmap')

## 一次性读取所需程序包。
## 
## [R语言高效数据框操作：tidyfst](https://z.itpub.net/article/detail/5EE2CA3CDCD527ADAF5071BF2ADF8874)
## 
## [「知乎」tidyft高性能数据操作](https://zhuanlan.zhihu.com/p/128645634)
## 最下面是tidyft的性能，占用空间最少，花费时间最少。
##   其实这个包基本拥有tidyfst的所有功能，只是原位更新的概念对于新手是有挑战...

library('tidyfst', warn.conflicts = FALSE)
library('tidyft', warn.conflicts = FALSE)
library('dplyr', warn.conflicts = FALSE)
library('lubridate', warn.conflicts = FALSE)
library('data.table', warn.conflicts = FALSE)
library('conflicted', warn.conflicts = FALSE)

conflict_prefer('nth', 'tidyft', quiet = TRUE)
conflict_prefer('fill', 'tidyft', quiet = TRUE)
conflict_prefer('nest', 'tidyft', quiet = TRUE)
conflict_prefer('unnest', 'tidyft', quiet = TRUE)
conflict_prefer('cummean', 'tidyft', quiet = TRUE)
conflict_prefer('group_by', 'tidyft', quiet = TRUE)
conflict_prefer('distinct', 'tidyft', quiet = TRUE)
conflict_prefer('filter', 'tidyft', quiet = TRUE)
conflict_prefer('select', 'tidyft', quiet = TRUE)
conflict_prefer('rename', 'tidyft', quiet = TRUE)
conflict_prefer('count', 'tidyft', quiet = TRUE)
conflict_prefer('arrange', 'tidyft', quiet = TRUE)
conflict_prefer('summarise', 'tidyft', quiet = TRUE)
conflict_prefer('separate', 'tidyft', quiet = TRUE)
conflict_prefer('lead', 'tidyft', quiet = TRUE)
conflict_prefer('lag', 'tidyft', quiet = TRUE)
conflict_prefer('unite', 'tidyft', quiet = TRUE)
conflict_prefer('left_join', 'tidyft', quiet = TRUE)
conflict_prefer('right_join', 'tidyft', quiet = TRUE)
conflict_prefer('inner_join', 'tidyft', quiet = TRUE)
conflict_prefer('full_join', 'tidyft', quiet = TRUE)
conflict_prefer('anti_join', 'tidyft', quiet = TRUE)
conflict_prefer('semi_join', 'tidyft', quiet = TRUE)
conflict_prefer('select_dt', 'tidyft', quiet = TRUE)
conflict_prefer('transpose', 'tidyft', quiet = TRUE)
conflict_prefer('setDT', 'tidyft', quiet = TRUE)
conflict_prefer('setnames', 'tidyft', quiet = TRUE)
conflict_prefer('mutate', 'dplyr', quiet = TRUE)
conflict_prefer('collapse', 'dplyr', quiet = TRUE)
conflict_prefer('year', 'lubridate', quiet = TRUE)
conflict_prefer('first', 'data.table', quiet = TRUE)
conflict_prefer('last', 'data.table', quiet = TRUE)
conflict_prefer('between', 'data.table', quiet = TRUE)
conflict_prefer('set', 'data.table', quiet = TRUE)

程序包 <- c(
  'devtools', 'Ipaper', 'knitr', 'kableExtra', 'tint', 'furrr', 'tidyr', 
  'readr', 'lubridate', 'reprex', 'stringr', 'feather', 'purrr', 
  'quantmod', 'tidyquant', 'tibbletime', 'timetk', 'plyr', 'dplyr', 
  'dbplyr', 'magrittr', 'sarima', 'tidyverse', 'memoise', 'htmltools', 
  'formattable', 'dtplyr', 'zoo', 'forecast', 'seasonal', 'magrittr', 
  'seasonalview', 'rjson', 'rugarch', 'rmgarch', 'mfGARCH', 'feather', 
  'sparklyr', 'jcolors', 'TSA', 'microbenchmark', 'dendextend', 'vembedr', 
  'lhmetools', 'gtools', 'stringi', 'pacman', 'profmem', 'ggthemes', 
  'flyingfox', 'htmltools', 'echarts4r', 'viridis', 'hrbrthemes', 'profvis', 
  'fable', 'fabletools', 'fable.prophet', 'Rfast', 'Metrics', 'MLmetrics', 
  'microbenchmark')

# load_pkg(程序包)
suppressAll(lib(程序包))
load_pkg(程序包)
rm(程序包)

.蜀道 <- getwd() |> 
    {\(.) str_split(., '/')}() |> 
    {\(.) c('/', .[[1]][2:5])}() |> 
    {\(.) c(., 'binary.com-interview-question-data/')}() |> 
    {\(.) paste(., collapse = '/')}() |> 
    {\(.) substring(., 2)}()

## 设置googleVis选项，促使plot.gvis只陈列HTML格式的完成品。
谷歌绘图设置 <- options(gvis.plot.tag = 'chart')

## <audio src='文艺坊曲库/bigmoney.mp3' autoplay controls loop></audio>

conflict_prefer('llply', 'Ipaper', quiet = TRUE)
conflict_prefer('view', 'tibble', quiet = TRUE)
conflict_prefer('year', 'lubridate', quiet = TRUE)
conflict_prefer('permutations', 'gtools', quiet = TRUE)

## 检验是否已设置途径。
if (!exists('.蜀道')) {
  .蜀道 <- getwd() |> 
    {\(.) str_split(., '/')}() |> 
    {\(.) c('/', .[[1]][2:5])}() |> 
    {\(.) c(., 'binary.com-interview-question-data/')}() |> 
    {\(.) paste(., collapse = '/')}() |> 
    {\(.) substring(., 2)}()
}

if (!exists('.蜀道仓库')) {
  .蜀道仓库 <- paste0(.蜀道, '文艺数据库/fx/USDJPY/仓库/')
}

## 
## 倘若环境尚未有数据，读取文件数据。
## **小插曲**：数据应该使用经过过滤`NA值`和重新赋值`周`、`周分计`、`日分计`、
##   `时分计`、`序列`等参数和数据的**样本2**，而非**样本1**。
## 数据从原本 1324800 减至 1317600
# 样本[!is.na(闭市价)][]
## 1317600分钟 除以 7200分钟（一周） = 183周数
## 1317600分钟 除以 1440分钟（一天） = 915天数
## 1317600分钟 除以 720分钟（一小时） = 1830时数
## 
if (!exists('样本') || (nrow(样本) != 1317600)) {
  样本 <- readRDS(paste0(.蜀道, '文艺数据库/fx/USDJPY/样本2.rds'))
}
样本 <- 样本[order(序列)]
# saveRDS(样本[order(序列)], paste0(.蜀道, '文艺数据库/fx/USDJPY/样本2.rds'))

基准 <- 样本[年份 == 2018]$日期[1]
序列基准1 <- 样本[日期 == 基准][1]$序列
序列基准2 <- tail(样本[日期 <= as.Date('2018-07-01')], 1)$序列

样本2018半年 <- 样本[序列 %chin% (序列基准1 - 1200):序列基准2]
# saveRDS(样本2018半年, paste0(.蜀道, '文艺数据库/fx/USDJPY/样本2018半年.rds'))
rm(基准, 样本)

### ================================================================================
source('函数/日内高频指数平滑.R')
source('函数/汇总上奏.R')
source('函数/总汇结论.R')
source('函数/商鞅变法.R')
source('函数/整顿数据.R')

时间索引 <- unique(样本2018半年$日期)
基准 <- 样本2018半年[年份 == 2018]$日期[1]
时间索引 %<>% .[. >= 基准]
迭代基准 <- 样本2018半年[日期 %chin% 时间索引]$序列
数据量 <- 1200 #筛选数据中的最后1200观测值：样本2018半年[(.N - (数据量 - 1)):.N]
预测时间单位 <- 1

.模型选项 = c('MNN')

频率 = 1

日内高频指数平滑(
     时间索引 = 时间索引, 样本 = 样本2018半年, 数据量 = 数据量, 频率 = 频率, 
     预测时间单位 = 预测时间单位, .模型选项 = .模型选项)

# 整顿数据(1, 文件名 = '日内指数平滑2018数据', 是否移除文件夹 = '是')

### ================================================================================
source('函数/日内高频季节性自回归.R')

时间索引 <- unique(样本2018半年$日期)
基准 <- 样本2018半年[年份 == 2018]$日期[1]
时间索引 %<>% .[. >= 基准]
迭代基准 <- 样本2018半年[日期 %chin% 时间索引]$序列
数据量 <- 1200 #筛选数据中的最后1200观测值：样本2018半年[(.N - (数据量 - 1)):.N]
预测时间单位 <- 1

.模型选项 = c('自动化', '自回归滑均')
# .模型选项 %<>% .[1]
# .模型选项 %<>% .[2]
.差分阶数 = 0:2
.季节性差分阶数 = 0:1 
季节性与否 = c('是', '否')
## https://stackoverflow.com/questions/37400062/seasonality-in-auto-arima-from-forecast-package
#近似值与否 <- c(TRUE, FALSE)
#逐步精化与否 <- c(TRUE, FALSE)
信息量准则 = c('aicc', 'aic', 'bic')

## .时序规律 <- c(0, 0, 0)
.时序规律 <- permutations(6, 3, 0:5, repeats.allowed = TRUE) %>% 
  as.data.table
.时序规律 <- setnames(.时序规律, old = c('V1', 'V2', 'V3'), 
                  new = c('自回归阶数', '差分阶数', 
                          '滑均阶数'))[差分阶数 <= 2]

## .季节性规律参数 <- c(0, 0, 0)
.季节性规律参数 <- permutations(6, 3, 0:5, repeats.allowed = TRUE) %>% 
  as.data.table
.季节性规律参数 <- setnames(.季节性规律参数, old = c('V1', 'V2', 'V3'), 
                     new = c('季节性自回归阶数', '季节性差分阶数', '季节性滑均阶数'))[季节性差分阶数 <= 2] %>% 
  mutate_dt(总和 = rowSums(.)) %>% 
  filter_dt(总和 > 0) %>% 
  select_dt(-总和)

频率 = 1

## 由于forecast::Arima()出现多种错误信息，故此忽略使用该函数建模。
## https://github.com/englianhu/binary.com-interview-question/issues/6
llply(.模型选项, function(模型) {
  
  if (模型 == '自动化') {
    季回归0 <- llply(.差分阶数, function(差分阶数) {
      季回归1 <- llply(.季节性差分阶数, function(季节性差分阶数) {
        季回归2 <- llply(季节性与否, function(季节) {
          季回归3 <- llply(时间索引, function(时序) {
            成效 <- 日内高频季节性自回归(
              时间索引 = 时序, 样本 = 样本2018半年, .蜀道 = .蜀道, 
              文件名 = '季节性自回归', 数据量 = 数据量, 频率 = 频率, 
              预测时间单位 = 预测时间单位, .模型选项 = 模型, 
              .差分阶数 = 差分阶数, .季节性差分阶数 = 季节性差分阶数, 
              季节性与否 = 季节, 静态与否 = '叉', 记载自回归与否 = '叉', 
              信息量准则 = c('aicc', 'aic', 'bic'), 逐步精化与否 = '勾', 
              逐步精化量 = 94, #近似值与否=(length(x)>150|frequency(x)>12), 
              省略 = NULL, 计策谋略 = NULL, #x = y, 
              趋势 = NULL, 测试 = c('kpss', 'adf', 'pp'), 测试参数 = list(), 
              季节性测试参数 = list(), 
              季节性测试 = c('seas', 'ocsb', 'hegy', 'ch'), 
              允许截距与否 = '勾', 允许包含均值与否 = '勾', 
              博克斯考克斯变换 = NULL, 
              偏差调整与否 = '叉', 多管齐下与否 = '叉', 核心量 = 2, 
              包含均值与否 = '勾')
          })
        })
      })
    })
    
  }
  
  if (模型 == '自回归滑均') {
    季回归0 <- llply(1:nrow(.时序规律), function(迭数1) {
      季回归1 <- llply(1:nrow(.季节性规律参数), function(迭数2) {
        季回归2 <- llply(时间索引, function(时序) {
          成效 <- 日内高频季节性自回归(
            时间索引 = 时序, 样本 = 样本2018半年, .蜀道 = .蜀道, 
            文件名 = '季节性自回归', 数据量 = 数据量, 频率 = 频率, 
            预测时间单位 = 预测时间单位, .模型选项 = 模型, 
            .时序规律 = unlist(.时序规律[迭数1,]), 
            .季节性规律参数 = unlist(.季节性规律参数[迭数2,]), 趋势 = NULL, 
            允许包含均值与否 = '勾', 允许截距与否 = '叉', 
            包含均值与否 = '勾', 包含截距 = '勾', 
            #包含常数与否 = 包含常数与否, 
            #统计模型 = NULL, 博克斯考克斯变换 = 博克斯考克斯变换, x = y, 
            偏差调整与否 = '叉', 计策谋略 = c('CSS-ML', 'ML', 'CSS'))
        })
      })
    })
  }
  return(模型)
})
# 整顿数据(1, 文件名 = '季节性自回归2018数据', 是否移除文件夹 = '是')

### ================================================================================
source('函数/日内高频季节性自回归.R')

## ======== 居住在英国布里斯托尔港口，修读气象学系的英国基督洋妞儿芈拉不可以死 ========
文件名 = '日内高频季节性自回归'
.模型选项 = c('自动化', '自回归滑均')
# .模型选项 = .模型选项[1]
# .模型选项 = .模型选项[2]
列印 = '勾'
样本 = 样本2018半年
季节性与否 = '勾'
静态与否 = '勾'
记载自回归与否 = '勾'
逐步精化与否 = '勾'
允许截距与否 = '勾'
允许包含均值与否 = '勾'
偏差调整与否 = '勾'
多管齐下与否 = '勾'
包含均值与否 = '勾'
包含截距与否 = '叉'
迭数1 <- 迭代基准[1]
省略 = NULL
计策谋略 = c('CSS-ML', 'ML', 'CSS')
趋势 = NULL
博克斯考克斯变换 = NULL

options(digits = 22)
require('tidyft', quietly = TRUE)
require('forecast', quietly = TRUE)
require('Ipaper', quietly = TRUE)
conflict_prefer('llply', 'Ipaper', quiet = TRUE)
conflict_prefer('mutate_dt', 'tidyft', quiet = TRUE)
conflict_prefer('rename_dt', 'tidyft', quiet = TRUE)
conflict_prefer('select_dt', 'tidyft', quiet = TRUE)

if (!'data.table' %in% class(样本)) 样本 %<>% as.data.table

if (!exists('.蜀道') || is.null(.蜀道)) {
  .蜀道 <- getwd() |> 
    {\(.) str_split(., '/')}() |> 
    {\(.) c('/', .[[1]][2:5])}() |> 
    {\(.) c(., 'binary.com-interview-question-data/')}() |> 
    {\(.) paste(., collapse = '/')}() |> 
    {\(.) substring(., 2)}()
}
.蜀道仓库 <- paste0(.蜀道, '文艺数据库/fx/USDJPY/仓库/')
.模型选项表 = c('自动化', '自回归滑均')

if (!季节性与否 %in% c('勾', '叉')) stop("季节性与否 = '勾' 或 '叉'")
if (!静态与否 %in% c('勾', '叉')) stop("静态与否 = '勾' 或 '叉'")
if (!记载自回归与否 %in% c('勾', '叉')) stop("记载自回归与否 = '勾' 或 '叉'")
if (!逐步精化与否 %in% c('勾', '叉')) stop("逐步精化与否 = '勾' 或 '叉'")
if (!允许截距与否 %in% c('勾', '叉')) stop("允许截距与否 = '勾' 或 '叉'")
if (!允许包含均值与否 %in% c('勾', '叉')) stop("允许包含均值与否 = '勾' 或 '叉'")
if (!偏差调整与否 %in% c('勾', '叉')) stop("偏差调整与否 = '勾' 或 '叉'")
if (!多管齐下与否 %in% c('勾', '叉')) stop("多管齐下与否 = '勾' 或 '叉'")
if (!包含均值与否 %in% c('勾', '叉')) stop("包含均值与否 = '勾' 或 '叉'")
if (!包含截距与否 %in% c('勾', '叉')) stop("包含截距与否 = '勾' 或 '叉'")

季节性与否 <- ifelse2(季节性与否 == '勾', TRUE, FALSE)
静态与否 <- ifelse2(静态与否 == '勾', TRUE, FALSE)
记载自回归与否 <- ifelse2(记载自回归与否 == '勾', TRUE, FALSE)
逐步精化与否 <- ifelse2(逐步精化与否 == '勾', TRUE, FALSE)
允许截距与否 <- ifelse2(允许截距与否 == '勾', TRUE, FALSE)
允许包含均值与否 <- ifelse2(允许包含均值与否 == '勾', TRUE, FALSE)
偏差调整与否 <- ifelse2(偏差调整与否 == '勾', TRUE, FALSE)
多管齐下与否 <- ifelse2(多管齐下与否 == '勾', TRUE, FALSE)
包含均值与否 <- ifelse2(包含均值与否 == '勾', TRUE, FALSE)
包含截距与否 <- ifelse2(包含截距与否 == '勾', TRUE, FALSE)

## 假设数据量 = 1200分钟
## 频率 = 1200
## 20小时一周期（1200分钟循环1次）
## 10小时一周期（600分钟循环2次）
循环周期 <- 数据量/频率
迭代基准 <- 样本[日期 %chin% 时间索引]$序列


迭数列表 <- (迭数1 - 数据量):(迭数1 - 1)
培训样本 <- 样本[序列 %chin% 迭数列表]

if (列印 == '勾') {
  cat('\n======== 居住在英国布里斯托尔港口，修读气象学系的英国基督洋妞儿芈拉不可以死 ========\n')
  cat('培训样本[', '数据量：', 数据量, '频率：', 频率, '-', 
      '培训样本最终序列号：', 培训样本[.N]$序列, ']\n')
  print(培训样本)
  
  cat('\n------ 秦孝公🌟陈祯禄，商鞅变法，铲除巫裔，推翻马来回教宦官巫师政权，千古一帝。------\n')
  cat('预测样本[', '数据量：', 数据量, '频率：', 频率, '-', 
      '预测样本序列号：', 迭数1, ']\n')
  预测样本 <- 样本[序列 == 培训样本[.N]$序列 + 预测时间单位]
  print(预测样本)
}

# 季回归 <- 培训样本[, .(年月日时分, 闭市价)] %>% 
#   as.matrix %>% 
#   tk_ts(frequency = 频率)
季回归 <- 培训样本$闭市价 |> 
  {\(.) matrix(., dimnames = list(培训样本$年月日时分, '闭市价'))}() |> 
  {\(.) tk_ts(., frequency = 频率)}()
rownames(季回归) <- 培训样本$年月日时分

if (!.模型选项 %in% .模型选项表) 
  stop("错误信息：.模型选项 = '自动化' 或 '自回归滑均'")

if (.模型选项 == '自动化') {
  半成品 <- tryCatch({
    auto.arima(
      季回归, d = .差分阶数, D = .季节性差分阶数, seasonal = 季节性与否, 
      stationary = 静态与否, trace = 记载自回归与否, 
      ic = 信息量准则, stepwise = 逐步精化与否, nmodels = 逐步精化量, 
      #approximation = 近似值与否, 
      method = 计策谋略, truncate = 省略, #x = y, 
      xreg = 趋势, test = 测试, lambda = 博克斯考克斯变换, 
      test.args = 测试参数, allowdrift = 允许截距与否, 
      seasonal.test = 季节性测试, seasonal.test.args = 季节性测试参数, 
      allowmean = 允许包含均值与否, biasadj = 偏差调整与否, 
      parallel = 多管齐下与否, num.cores = 核心量)
  }, 错误信息 = function(错误信息参数) NULL)
  
  半成品 <- 预测样本 |> 
    {\(.) mutate_dt(., 市场价 = 闭市价, 预测价 = coef(半成品))}() |> 
    {\(.) select_dt(., 年月日时分, 市场价, 预测价)}()
  
  模型名称 <- paste0(
    .模型选项, '_差分阶数_', .差分阶数, '_季节性差分阶数_', .季节性差分阶数, 
    '_季节性与否_', 季节性与否, '_静态与否_', 静态与否, 
    '_记载自回归与否_', 记载自回归与否, '_信息量准则_', 信息量准则, 
    '_逐步精化与否_', 逐步精化与否, '_计策谋略_', 计策谋略, 
    '_数据量', 数据量, 
    '_频率', 频率, '_预测时间单位', 预测时间单位, 
    '_', 预测样本$年月日时分, 'CST.rds')
}

if (.模型选项 == '自回归滑均') {
  # 半成品 <- 培训样本[, .(年月日时分, 闭市价)] %>%  as.xts
  半成品 <- tryCatch({
    Arima(
      季回归, order = .时序规律, seasonal = .季节性规律参数, 
      xreg = 趋势, include.mean = 包含均值与否, 
      include.drift = 包含截距与否, #include.constant = 包含常数, 
      #model = 统计模型, lambda = 博克斯考克斯变换, x = y, 
      biasadj = 偏差调整与否, method = 计策谋略)
  }, 错误信息 = function(错误信息参数) NULL)
  
  模型名称 <- paste0(
    '自回归滑动平均', 
    paste(.时序规律, collapse = ''), '_季节性', 
    paste(.季节性规律参数, collapse = ''), '_', 数据量, '_', 
    预测时间单位, '_', 预测样本$年月日时分, 'CST.rds')
}

if (列印 == '勾') {
  cat('\n------ 秦孝公🌟陈祯禄，商鞅变法，铲除巫裔，推翻马来回教宦官巫师政权，千古一帝。------\n')
  cat('预测样本[', '数据量：', 数据量, '频率：', 频率, '-', 
      '预测数据序列号：', 迭数1, ']\n')
  print(半成品)
}

文件名 <- paste0('季回归_', .模型选项, '_数据量', 数据量, 
              '_频率', 频率, '_', 半成品$年月日时分, 'CST.rds')


source('函数/日内高频季节性自回归.R')


成效 <- 日内高频季节性自回归(
  时间索引 = 时间索引, 样本 = 样本2018半年, 
  文件名 = '日内高频季节性自回归', 数据量 = 数据量, 频率 = 频率, 
  预测时间单位 = 预测时间单位, .模型选项 = .模型选项[2], 
  .差分阶数 = 差分阶数, .季节性差分阶数 = 季节性差分阶数, 
  季节性与否 = '勾', 静态与否 = '叉', 记载自回归与否 = '叉', 
  信息量准则 = c('aicc', 'aic', 'bic'), 逐步精化与否 = '勾', 
  逐步精化量 = 94, #近似值与否=(length(x)>150|frequency(x)>12), 
  省略 = NULL, 计策谋略 = NULL, #x = y, 
  趋势 = NULL, 测试 = c('kpss', 'adf', 'pp'), 测试参数 = list(), 
  季节性测试参数 = list(), 季节性测试 = c('seas', 'ocsb', 'hegy', 'ch'), 
  允许截距与否 = '勾', 允许包含均值与否 = '勾', 博克斯考克斯变换 = NULL, 
  偏差调整与否 = '叉', 多管齐下与否 = '叉', 核心量 = 2, 包含均值与否 = '勾')



预测样本 %>% 
  mutate_dt(市场价 = 闭市价, 预测价 = coef(半成品)) %>% 
  select_dt(年月日时分, 市场价, 预测价)

半成品 <- 预测样本 |> 
  {\(.) mutate_dt(., 市场价 = 闭市价, 预测价 = coef(半成品))}() |> 
  {\(.) select_dt(., 年月日时分, 市场价, 预测价)}()
  
半成品 <- tryCatch({
  Arima(
    季回归, order = unlist(.时序规律[1,]), 
    seasonal = list(order = unlist(.季节性规律参数[1,]), period = 循环周期), 
    xreg = 趋势, include.mean = 包含均值与否, 
    include.drift = 包含截距与否, #include.constant = 包含常数, 
    #model = 统计模型, lambda = 博克斯考克斯变换, x = y, 
    biasadj = 偏差调整与否, method = 计策谋略)
}, 错误信息 = function(错误信息参数) NULL)

半成品 <- tryCatch({
  Arima(
    季回归, order = unlist(.时序规律[1,]), 
    seasonal = unlist(.季节性规律参数[1,]), 
    xreg = 趋势, include.mean = 包含均值与否, 
    include.drift = TRUE, #包含截距与否, #include.constant = 包含常数, 
    #model = 统计模型, lambda = 博克斯考克斯变换, x = y, 
    biasadj = 偏差调整与否, method = 'CSS')#计策谋略)
}, 错误信息 = function(错误信息参数) NULL)












