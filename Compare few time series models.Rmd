---
title: "[Deriv.com](https://github.com/englianhu/binary.com-interview-question) - Interday High Frequency Trading Models Comparison <span style='color:#4E79A7'>**Review**"
subtitle: "Compare few time series models with Performance"
author: "[¬ÆŒ≥œÉ, Lian Hu](https://englianhu.github.io/) <img src='www/quantitative trader 1.jpg' width='24'> <img src='www/RYU.jpg' width='24'> <img src='www/ENG.jpg' width='24'>¬Æ <img src='www/xueba2.jpg' width='24'>"
date: "`r lubridate::today('Asia/Tokyo')`"
output:
  html_document: 
    mathjax: https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
    css: CSSBackgrounds.css
---

# Load Packages

```{r, warning = FALSE, message = FALSE}
if(!suppressPackageStartupMessages(require('BBmisc'))) {
  utils::install.packages('BBmisc', dependencies = TRUE, INSTALL_opts = '--no-lock')
}
suppressPackageStartupMessages(require('BBmisc'))
# suppressPackageStartupMessages(require('rmsfuns'))

pkgs <- c('devtools', 'knitr', 'kableExtra', 'tint', 'dygraphs', 
          'devtools','readr', 'lubridate', 'data.table', 'reprex', 
          'feather', 'purrr', 'quantmod', 'tidyquant', 'plotly', 
          'furrr', 'flyingfox', 'tidyr', 'jsonlite', 'MASS', 
          'timetk', 'plyr', 'dplyr', 'stringr', 'magrittr', 'tdplyr', 
          'tidyverse', 'memoise', 'htmltools', 'formattable', 'rbokeh', 
          'dash', 'dashCoreComponents', 'dashHtmlComponents', 'dtplyr', 
          ##https://dashr.plotly.com
          'zoo', 'forecast', 'seasonal', 'seasonalview', 'rjson', 
          'rugarch', 'rmgarch', 'mfGARCH', 'sparklyr', 'jcolors', 
          'microbenchmark', 'dendextend', 'lhmetools', 'ggthemr', 
          'stringr', 'pacman', 'profmem', 'ggthemes', 
          'htmltools', 'echarts4r', 'viridis', 'hrbrthemes', 'tsibble', 
          'fable', 'fabletools', 'tsibbledata', 'tibbletime', 'feasts', 
          'fpp3', 'prophet', 'fasster', 
          'fpp3', 'MASS')

# remotes::install_github("robjhyndman/fpp3-package")
# https://tidyverts.github.io/tidy-forecasting-principles/tsibble.html
# https://facebook.github.io/prophet/docs/quick_start.html
# https://github.com/mpiktas/midasr
# https://github.com/onnokleen/mfGARCH
# devtools::install_github("business-science/tibbletime")
# devtools::install_github("DavisVaughan/furrr")

suppressAll(lib(pkgs))
# load_pkg(pkgs)

## Set the timezone but not change the datetime
Sys.setenv(TZ = 'Asia/Tokyo')
## options(knitr.table.format = 'html') will set all kableExtra tables to be 'html', otherwise need to set the parameter on every single table.
options(warn = -1, knitr.table.format = 'html')#, digits.secs = 6)

## https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-abnor-in-rmd-but-not-in-r-script
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, 
                      message = FALSE, cache.lazy = FALSE)

## https://www.researchgate.net/post/How_to_solve_abnor_cannot_allocate_vector_of_size_12_Gb_in_R
#memory.size() ### Checking your memory size
#memory.limit() ## Checking the set limit
#memory.size(size=500000)
#memory.limit(size=56000) ### expanding your memory _ here it goes beyond to your actually memory. This 56000 is proposed for 64Bit.

rm(pkgs, funs)
```

# Read Data

```{r, warning = FALSE, message = FALSE, results = 'asis'}
## read files if not exists
if(!exists('dsmp')) {
  dsmp <- readRDS('C:/Users/User/Documents/GitHub/binary.com-interview-question-data/data/fx/USDJPY/dsmp.rds')}

## save files if not exists
if(!file.exists('C:/Users/User/Documents/GitHub/binary.com-interview-question-data/data/fx/USDJPY/dsmp.rds')) {
  saveRDS(dsmp, 'C:/Users/User/Documents/GitHub/binary.com-interview-question-data/data/fx/USDJPY/dsmp.rds')}
```

# Modeling

## Seasonal

### Wk >> Dy

#### `timetk::tk_ts()`

```{r, warning = FALSE, message = FALSE, results = 'asis'}
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
vrb <- 7200 #last 7200 observations DT[(.N - (vrb - 1)):.N]
frb <- 1440

i = 1

train <- dsmp[date < timeID[i]][(.N - (vrb - 1)):.N]
ctr <- (train[,(sq)][1]):(train[,(sq)][.N] + frb)
train_test <- dsmp[sq %in% ctr]

fit <- train %>% 
  as_tsibble(key = close, index = index) %>% 
  model(
    ets = ETS(close), 
    #ets_bc = ETS(box_cox(close, 0.3)),
    arima = ARIMA(close), 
    rw = RW(close), 
    rw_df = RW(close ~ drift()), 
    naive = NAIVE(close), 
    snaive = SNAIVE(close)
    )

fc <- fit %>% 
  forecast(h = frb)

fc %>% fabletools::accuracy(train_test)
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
## filter data by date
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
vrb <- 7200 #last 7200 observations DT[(.N - (vrb - 1)):.N]
frb <- 1440

i = 1

train <- dsmp[date < timeID[i]][(.N - (vrb - 1)):.N]
ctr <- (train[,(sq)][1]):(train[.N,(sq)] + frb)

## convert to tsibble data
train %<>% 
  as_tsibble(key = close, index = index)

train_test <- dsmp[sq %in% ctr] %>% 
  as_tsibble(key = close, index = index)

## modeling
fit <- train %>% 
  model(
    ets = ETS(close), 
    #ets_bc = ETS(box_cox(close, 0.3)),
    arima = ARIMA(close), 
    rw = RW(close), 
    rw_df = RW(close ~ drift()), 
    naive = NAIVE(close), 
    snaive = SNAIVE(close)
    )

## forecast
fc <- fit %>% 
  forecast(h = frb)

## accuracy
fc %>% fabletools::accuracy(train_test)
```

#### `timetk::tk_ts()`

[Chapter 12 Advanced forecasting methods in **Forecasting: Principles and Practice (3rd Edt)**](https://otexts.com/fpp3/advanced.html)

```{r, warning = FALSE, message = FALSE, results = 'asis'}
my_dcmp_spec <- decomposition_model(
  STL(close ~ season(period = 1440), robust = TRUE),
  ETS(season_adjust ~ season('N')))

fit <- smp1 %>% 
  as_tsibble(index = index) %>% 
  model(
    ets = ETS(close ~ trend('A')), 
    ets_bc = ETS(box_cox(close, 0.3)), #https://stackoverflow.com/questions/26617587/finding-optimal-lambda-for-box-cox-transform-in-r
    #ets_lg = ETS(my_scaled_logit(mdeaths, 750, 3000) ~ error('A') + trend('N') + season('A')), #http://fable.tidyverts.org/articles/transformations.html
    arima = ARIMA(close), 
    rw = RW(close), 
    rw_df = RW(close ~ drift()), 
    naive = NAIVE(close), 
    snaive = SNAIVE(close), 
    snaive_ = SNAIVE(close ~ lag('year'))#,
    #dcmp = my_dcmp_spec
    )
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
fit %>%
  forecast(h = 1440) %>% 
  autoplot()
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
dsmp %>% as_tsibble(key = c(qrt, mon, wek, wkdays, sq_1m), index = index)
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}

```

```{r, warning = FALSE, message = FALSE, results = 'asis'}

```

```{r, warning = FALSE, message = FALSE, results = 'asis'}

```




# Appendix

## Documenting File Creation 

It's useful to record some information about how your file was created.

- File creation date: 2018-08-28
- File latest updated date: `r today('Asia/Tokyo')`
- `r R.version.string`
- R version (short form): `r getRversion()`
- [**rmarkdown** package](https://github.com/rstudio/rmarkdown) version: `r packageVersion('rmarkdown')`
- File version: 1.0.1
- Author Profile: [¬ÆŒ≥œÉ, Eng Lian Hu](https://beta.rstudioconnect.com/content/4352/)
- GitHub: [Source Code](https://github.com/englianhu/binary.com-interview-question)
- Additional session information:

```{r, warning = FALSE, results = 'asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('magrittr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))
suppressMessages(require('knitr', quietly = TRUE))
suppressMessages(require('kableExtra', quietly = TRUE))

sys1 <- devtools::session_info()$platform %>% 
  unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL

sys2 <- data.frame(Sys.info()) %>% 
  dplyr::mutate(Category = rownames(.)) %>% .[2:1]
names(sys2)[2] <- c('Sys.info')
rownames(sys2) <- NULL

if (nrow(sys1) == 9 & nrow(sys2) == 8) {
  sys2 %<>% rbind(., data.frame(
  Category = 'Current time', 
  Sys.info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JSTüóæ')))
} else {
  sys1 %<>% rbind(., data.frame(
  Category = 'Current time', 
  session_info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JSTüóæ')))
}

sys <- cbind(sys1, sys2) %>% 
  kbl(caption = 'Additional session information:') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'CornflowerBlue') %>% 
  column_spec(4, background = 'DarkGrey') %>% 
  row_spec(9, bold = T, color = 'white', background = '#D7261E')

rm(sys1, sys2)
sys
```

## Reference

1) [High-Performance Time Series Forecasting in R & Python](https://www.youtube.com/watch?v=elQb4VzRINg)

2) 

---

<span style='color:RoyalBlue'>**Powered by - Copyright¬Æ Intellectual Property Rights of <img src='www/scb-logo3rs.jpg' width='24'> [SœÇŒπŒ≤rŒøŒ∫Œµrs TrŒ±dŒπŒ∑g¬ÆÔ∏è](http://www.scibrokes.com)ÁµåÂñ∂‰ºÅÊ•≠**</span>
